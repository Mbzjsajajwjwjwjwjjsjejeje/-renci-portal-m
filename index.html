<!DOCTYPE html>
<html lang="tr">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>√ñƒürenci Portalƒ±m (Final - V22)</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- TASARIM KODLARI --- */
        @media screen and (max-width: 768px) {
            body, .container { flex-direction: column !important; width: 100% !important; padding: 0 !important; }
            .sidebar { width: 100% !important; height: auto !important; display: block !important; margin-bottom: 20px; }
            .auth-box { width: 90% !important; margin: auto; }
            #myBoard { width: 300px !important; }
            .timers { width: 300px !important; }
        }

        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');
        :root { --primary: #6c5ce7; --bg: #dfe6e9; --panel: #fff; --text: #2d3436; --success:#00b894; --danger:#d63031; }
        body.koyu-mod { --primary: #a29bfe; --panel: #2d3436; --text: #dfe6e9; }
        
        body { font-family: 'Poppins', sans-serif; background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab); background-size: 400% 400%; animation: gradientBG 15s ease infinite; margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; color: var(--text); }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        
        .container { background: var(--panel); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; display: flex; width: 1200px; height: 800px; }
        
        /* Gƒ∞Rƒ∞≈û EKRANI */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:999; display:flex; justify-content:center; align-items:center; }
        .auth-box { padding: 40px; width: 350px; text-align: center; background: rgba(255, 255, 255, 0.95); border-radius: 20px; color: #333; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .auth-box input { background: #eee; border: none; padding: 15px; margin-bottom: 10px; border-radius: 30px; width: 100%; box-sizing: border-box; outline: none; font-size: 16px; }
        .auth-box button { background: linear-gradient(to right, #6c5ce7, #a29bfe); border: none; padding: 15px; border-radius: 30px; width: 100%; color: white; cursor: pointer; font-weight: bold; margin-top: 10px; transition: 0.3s; }
        .auth-box button:hover { transform: scale(1.05); }

        .sidebar { width: 240px; background: rgba(0,0,0,0.03); padding: 20px; display: flex; flex-direction: column; gap: 8px; border-right: 1px solid rgba(0,0,0,0.1); }
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        .menu-item { padding: 12px; cursor: pointer; border-radius: 10px; display: flex; gap: 10px; align-items: center; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; transform: translateX(5px); }
        .page { display: none; } .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .gizli { display: none !important; }
        
        /* Satran√ß & √ñzellikler */
        #myBoard { margin: 0 auto; width: 400px; }
        .timers { display: flex; justify-content: space-between; width: 400px; margin: 0 auto 10px auto; font-weight: bold; }
        .timer-box { padding: 5px 15px; background: #eee; border-radius: 5px; color:#333; }
        .timer-active { background: var(--success); color: white; transform: scale(1.1); transition: 0.3s; }
        
        .item-card { background: rgba(0,0,0,0.05); padding: 15px; margin-bottom: 8px; border-radius: 8px; border-left: 5px solid #ccc; }
        .basarili { border-left-color: var(--success); background: rgba(0, 184, 148, 0.1); }
        .basarisiz { border-left-color: var(--danger); background: rgba(214, 48, 49, 0.1); }
        
        input, textarea, select { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; font-family: 'Poppins', sans-serif;}
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; color: white; }
        .btn-yesil { background: var(--success); } .btn-kirmizi { background: var(--danger); } .btn-gri { background: #636e72; }
        
        .pomodoro-circle { width: 200px; height: 200px; border-radius: 50%; border: 5px solid var(--primary); display: flex; justify-content: center; align-items: center; font-size: 40px; font-weight: bold; margin: 20px auto; color: var(--primary); }
        
        /* Bekleme Ekranƒ± (Satran√ß) */
        #beklemeEkrani { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:99; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="authScreen" class="overlay">
        <div class="auth-box">
            <h2 id="authTitle" style="color:#2d3436; margin-bottom:20px;">Giri≈ü Yap</h2>
            
            <input type="text" id="kAdiInput" placeholder="Kullanƒ±cƒ± Adƒ± (T√ºrk√ße karakter yok)">
            <input type="password" id="sifreInput" placeholder="≈ûifre">
            
            <button onclick="islemYap()" id="btnIslem">Giri≈ü Yap</button>

            <p onclick="modDegistir()" id="toggleText" style="cursor:pointer; font-size:14px; margin-top:20px; font-weight:bold; color:#2d3436; text-decoration: underline;">Hesabƒ±n yok mu? Kayƒ±t Ol</p>
        </div>
    </div>

    <div id="appScreen" class="container gizli">
        <div class="sidebar">
            <h3 style="text-align:center; color: var(--primary);"><i class="fas fa-graduation-cap"></i> Portal</h3>
            <div class="menu-item active" onclick="sayfaGec('dashboard')"><i class="fas fa-home"></i> Ana Sayfa</div>
            <div class="menu-item" onclick="sayfaGec('pomodoro')"><i class="fas fa-clock"></i> Ders √áalƒ±≈üma</div>
            <div class="menu-item" onclick="sayfaGec('oyunlar')"><i class="fas fa-chess-king"></i> Arena (Satran√ß)</div>
            <div class="menu-item" onclick="sayfaGec('todo')"><i class="fas fa-stopwatch"></i> Zamanlƒ± G√∂rev</div>
            <div class="menu-item" onclick="sayfaGec('notlar')"><i class="fas fa-calculator"></i> Not Hesapla</div>
            <div class="menu-item" onclick="sayfaGec('program')"><i class="fas fa-calendar-alt"></i> Ders Programƒ±</div>
            <div class="menu-item" onclick="sayfaGec('gunluk')"><i class="fas fa-book"></i> G√ºnl√ºk</div>
            <div class="menu-item" onclick="sayfaGec('sohbet')"><i class="fas fa-comments"></i> Sohbet</div>
            <div style="margin-top:auto; text-align:center;">
                <p id="karsilama" style="font-size:14px; font-weight:bold;"></p>
                <button onclick="cikisYap()" class="btn btn-kirmizi" style="width:100%;">√áƒ±kƒ±≈ü Yap</button>
            </div>
        </div>

        <div class="content">
            
            <div id="dashboard" class="page active">
                <h2>üëã Ho≈ügeldin, <span id="dashUser"></span></h2>
                <div style="display:flex; gap:10px; margin-top:20px;">
                    <div style="flex:1; background:#a29bfe; color:white; padding:20px; border-radius:10px; text-align:center;">
                        <h3>Satran√ß Puanƒ±</h3><h1 id="dashPuan">0</h1>
                    </div>
                    <div style="flex:1; background:#00b894; color:white; padding:20px; border-radius:10px; text-align:center;">
                        <h3>Bekleyen G√∂rev</h3><h1 id="dashGorev">0</h1>
                    </div>
                </div>
            </div>

            <div id="pomodoro" class="page" style="text-align:center;">
                <h2>üçÖ Pomodoro</h2>
                <div class="pomodoro-circle" id="pomoSure">25:00</div>
                <div style="margin-top:20px;">
                    <button class="btn btn-yesil" onclick="dersBaslat(25)">Ders (25dk)</button>
                    <button class="btn btn-yesil" style="background:#0984e3;" onclick="dersBaslat(5)">Mola (5dk)</button>
                    <button id="pomoDurBtn" class="btn btn-kirmizi" onclick="pomoDuraklat()">Durdur</button>
                </div>
            </div>

            <div id="oyunlar" class="page" style="position: relative;">
                <div id="beklemeEkrani" class="gizli">
                    <div id="beklemeIcerik">
                        <div class="spinner"></div><h2>RAKƒ∞P ARANIYOR...</h2>
                        <button onclick="beklemeyiIptalEt()" class="btn btn-kirmizi">ƒ∞ptal</button>
                    </div>
                    <div id="geriSayimIcerik" class="gizli">
                        <h2>RAKƒ∞P BULUNDU!</h2><h1 id="geriSayimText" style="font-size:80px; color:var(--primary);">5</h1>
                    </div>
                </div>
                
                <h2 style="text-align:center;">‚ôüÔ∏è Satran√ß Arenasƒ±</h2>
                <div id="lobiButonlari" style="text-align:center; margin-bottom:20px;">
                    <button class="btn btn-gri" onclick="oyunModuSec('bot')">ü§ñ Bot ile Oyna</button>
                    <button class="btn btn-yesil" onclick="dereceliGir()">üî• Dereceli (Online)</button>
                </div>

                <div id="oyunAlani" class="gizli">
                    <div class="timers">
                        <div id="timerW" class="timer-box">Beyaz: 10:00</div>
                        <div id="timerB" class="timer-box">Siyah: 10:00</div>
                    </div>
                    <div id="myBoard"></div>
                    <p id="siraKimde" style="text-align:center; font-weight:bold; margin-top:5px;">Sƒ±ra: Beyaz</p>
                    <div style="text-align:center; margin-top:10px;">
                        <button class="btn btn-kirmizi" onclick="pesEt()">Oyunu Bitir / Pes Et</button>
                    </div>
                </div>
            </div>

            <div id="todo" class="page">
                <h2>‚è±Ô∏è Zamanlƒ± G√∂revler</h2>
                <div style="display:flex; gap:5px;">
                    <input id="todoIn" placeholder="G√∂rev nedir?">
                    <input type="number" id="todoTime" placeholder="Sn" style="width:80px;">
                    <button class="btn btn-yesil" style="width:100px;" onclick="gorevEkle()">Ba≈ülat</button>
                </div>
                <div id="todoList" style="margin-top:20px;"></div>
            </div>

            <div id="notlar" class="page">
                <h2>üßÆ Not Hesapla</h2>
                <div style="display:flex; gap:5px;">
                    <input id="dersAdi" placeholder="Ders Adƒ±">
                    <input id="vizeNot" type="number" placeholder="Vize (%40)">
                    <input id="finalNot" type="number" placeholder="Final (%60)">
                    <button class="btn btn-yesil" onclick="notHesapla()">Hesapla</button>
                </div>
                <div id="notListesi" style="margin-top:20px;"></div>
            </div>

            <div id="program" class="page">
                <h2>üìÖ Haftalƒ±k Program</h2>
                <table id="programTablosu"><thead><tr><th>Saat</th><th>Pzt</th><th>Sal</th><th>√áar</th><th>Per</th><th>Cum</th></tr></thead><tbody></tbody></table>
                <button class="btn btn-yesil" style="margin-top:10px;" onclick="programKaydet()">Kaydet</button>
            </div>

            <div id="gunluk" class="page">
                <h2>üìî G√ºnl√ºk (Gizli)</h2>
                <textarea id="gunlukIn" rows="5" placeholder="Bug√ºn neler ya≈üadƒ±n?"></textarea>
                <button class="btn btn-yesil" onclick="gunlukEkle()">G√ºnl√ºƒüe Yaz</button>
                <div id="gunlukList" style="margin-top:20px;"></div>
            </div>

            <div id="sohbet" class="page">
                <h2>üí¨ Genel Sohbet</h2>
                <div id="chatArea" style="height:350px; overflow-y:scroll; border:1px solid #ddd; padding:10px; border-radius:5px; background:white; margin-bottom:10px;"></div>
                <div style="display:flex; gap:5px;">
                    <input id="chatIn" placeholder="Mesaj yaz...">
                    <button class="btn btn-yesil" style="width:80px;" onclick="chatYolla()">Yolla</button>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- üî• Dƒ∞KKAT: BURASI BO≈û! KENDƒ∞ KODLARINI YAPI≈ûTIR üî• ---
        const firebaseConfig = {
            // ... Buraya Firebase'den kopyaladƒ±ƒüƒ±n kodu yapƒ±≈ütƒ±r ...
        };
        // -----------------------------------------------------------

        // G√úVENLƒ∞K KONTROL√ú: Anahtarlar girilmemi≈üse uyarƒ± ver
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            alert("HATA: Firebase API Anahtarlarƒ±nƒ± yapƒ±≈ütƒ±rmayƒ± unuttun! Kodun en altƒ±na bak.");
        }

        const database = firebase.database();
        const auth = firebase.auth();
        let user = null, kayit = false;
        let board = null, game = new Chess();
        
        // Satran√ß Deƒüi≈ükenleri
        let myColor = 'w', aktifMod = null;
        let wTime = 600, bTime = 600, chessInterval = null;

        if(localStorage.getItem("koyuMod") === "1") document.body.classList.add("koyu-mod");

        // --- Gƒ∞Rƒ∞≈û Sƒ∞STEMƒ∞ (Kullanƒ±cƒ± Adƒ± -> Gizli Mail) ---
        function modDegistir() { 
            kayit = !kayit; 
            document.getElementById("authTitle").innerText = kayit ? "Kayƒ±t Ol" : "Giri≈ü Yap";
            document.getElementById("btnIslem").innerText = kayit ? "Kayƒ±t Ol" : "Giri≈ü Yap";
            document.getElementById("toggleText").innerText = kayit ? "Zaten hesabƒ±n var mƒ±? Giri≈ü Yap" : "Hesabƒ±n yok mu? Kayƒ±t Ol";
        }

        function islemYap() {
            // Eƒüer Firebase y√ºklenemediyse (Anahtar yoksa)
            if (!auth) return alert("HATA: Firebase baƒülƒ± deƒüil. API anahtarlarƒ±nƒ± kontrol et.");

            let kAdi = document.getElementById("kAdiInput").value.trim().replace(/\s/g, '').toLowerCase(); 
            let pass = document.getElementById("sifreInput").value;
            
            if(kAdi.length < 3) return alert("Kullanƒ±cƒ± adƒ± en az 3 karakter olmalƒ±!");
            if(pass.length < 6) return alert("≈ûifre en az 6 karakter olmalƒ±!");

            let fakeEmail = kAdi + "@portal.com";

            if(kayit) {
                auth.createUserWithEmailAndPassword(fakeEmail, pass)
                    .then(() => alert("Kayƒ±t Ba≈üarƒ±lƒ±! Giriliyor..."))
                    .catch(e => {
                        if(e.code === 'auth/email-already-in-use') alert("Bu kullanƒ±cƒ± adƒ± ZATEN ALINMI≈û! Ba≈üka bir isim se√ß.");
                        else alert("Hata: " + e.message);
                    });
            } else {
                auth.signInWithEmailAndPassword(fakeEmail, pass)
                    .catch(e => alert("HATA: Kullanƒ±cƒ± adƒ± veya ≈üifre yanlƒ±≈ü!"));
            }
        }

        auth.onAuthStateChanged(u => {
            if (u) {
                user = u.email.split('@')[0];
                document.getElementById("authScreen").classList.add("gizli");
                document.getElementById("appScreen").classList.remove("gizli");
                document.getElementById("karsilama").innerText = "üë§ " + user;
                document.getElementById("dashUser").innerText = user;
                yukleVeriler();
                baslatSohbet();
            } else {
                document.getElementById("authScreen").classList.remove("gizli");
                document.getElementById("appScreen").classList.add("gizli");
            }
        });

        function cikisYap() { auth.signOut().then(()=>location.reload()); }
        function getRef(path) { return database.ref(path + '/' + user); } 

        // --- SATRAN√á (LOBƒ∞ + ZAMANLAYICI + GERƒ∞ SAYIM) ---
        function dereceliGir() {
            document.getElementById("lobiButonlari").classList.add("gizli");
            document.getElementById("beklemeEkrani").classList.remove("gizli");
            
            database.ref('lobby').once('value', s => {
                let lob = s.val();
                if(!lob || lob.status === 'empty') {
                    database.ref('lobby').set({status: 'waiting', p1: user});
                    myColor = 'w';
                    database.ref('lobby').on('child_changed', snap => {
                        if(snap.val() === 'ready') baslatGeriSayim();
                    });
                } else if (lob.status === 'waiting') {
                    database.ref('lobby').update({status: 'ready', p2: user});
                    myColor = 'b';
                    baslatGeriSayim();
                } else {
                    alert("Sunucu dolu!"); beklemeyiIptalEt();
                }
            });
        }

        function baslatGeriSayim() {
            document.getElementById("beklemeIcerik").classList.add("gizli");
            document.getElementById("geriSayimIcerik").classList.remove("gizli");
            let c = 5;
            let i = setInterval(() => {
                c--; document.getElementById("geriSayimText").innerText = c;
                if(c<=0) { clearInterval(i); oyunBaslat('online'); }
            }, 1000);
        }

        function oyunBaslat(mod) {
            aktifMod = mod;
            document.getElementById("beklemeEkrani").classList.add("gizli");
            document.getElementById("oyunAlani").classList.remove("gizli");
            document.getElementById("lobiButonlari").classList.add("gizli");
            
            game.reset();
            wTime = 600; bTime = 600;
            baslatSatrancSayaci();
            
            if(aktifMod === 'online') {
                database.ref('game').on('value', s => {
                    let v = s.val();
                    if(v && v.fen !== game.fen()) {
                        game.load(v.fen);
                        board.position(v.fen);
                        kontrolEtBittiMi();
                    }
                });
            }

            if(board) board.destroy();
            board = Chessboard('myBoard', {
                draggable: true,
                position: 'start',
                orientation: myColor === 'b' && mod === 'online' ? 'black' : 'white',
                onDragStart: (s, p) => {
                    if(game.game_over()) return false;
                    if(mod === 'online' && game.turn() !== myColor) return false;
                    if(mod === 'bot' && game.turn() === 'b') return false;
                },
                onDrop: (s, t) => {
                    let m = game.move({from: s, to: t, promotion: 'q'});
                    if(m === null) return 'snapback';
                    
                    if(mod === 'online') database.ref('game').set({fen: game.fen(), turn: game.turn()});
                    if(mod === 'bot') setTimeout(botHamlesi, 250);
                    kontrolEtBittiMi();
                }
            });
        }

        function baslatSatrancSayaci() {
            clearInterval(chessInterval);
            chessInterval = setInterval(() => {
                if(game.game_over()) { clearInterval(chessInterval); return; }
                if(game.turn() === 'w') {
                    wTime--;
                    document.getElementById("timerW").classList.add("timer-active");
                    document.getElementById("timerB").classList.remove("timer-active");
                } else {
                    bTime--;
                    document.getElementById("timerB").classList.add("timer-active");
                    document.getElementById("timerW").classList.remove("timer-active");
                }
                
                let mw = Math.floor(wTime/60), sw = wTime%60;
                let mb = Math.floor(bTime/60), sb = bTime%60;
                document.getElementById("timerW").innerText = `Beyaz: ${mw}:${sw<10?'0':''}${sw}`;
                document.getElementById("timerB").innerText = `Siyah: ${mb}:${sb<10?'0':''}${sb}`;
                document.getElementById("siraKimde").innerText = "Sƒ±ra: " + (game.turn()==='w'?'Beyaz':'Siyah');

                if(wTime<=0 || bTime<=0) { clearInterval(chessInterval); alert("S√ºre bitti!"); }
            }, 1000);
        }

        function botHamlesi() {
            let moves = game.moves();
            let move = moves[Math.floor(Math.random() * moves.length)];
            game.move(move);
            board.position(game.fen());
            kontrolEtBittiMi();
        }

        function kontrolEtBittiMi() {
            if(game.game_over()) {
                clearInterval(chessInterval);
                alert("Oyun Bitti!");
                if(aktifMod === 'online') database.ref('lobby').set({status:'empty'});
            }
        }

        function pesEt() {
            alert("Pes ettin!");
            if(aktifMod === 'online') database.ref('lobby').set({status:'empty'});
            oyunModuSec('menu');
        }

        function oyunModuSec(t) {
            if(t==='bot') oyunBaslat('bot');
            if(t==='menu') {
                document.getElementById("oyunAlani").classList.add("gizli");
                document.getElementById("lobiButonlari").classList.remove("gizli");
            }
        }
        function beklemeyiIptalEt() {
            database.ref('lobby').set({status:'empty'});
            document.getElementById("beklemeEkrani").classList.add("gizli");
            document.getElementById("lobiButonlari").classList.remove("gizli");
        }

        // --- G√úNL√úK (OKU BUTONLU) ---
        function gunlukEkle() {
            let t = document.getElementById("gunlukIn").value;
            if(t) { getRef('gunluk').push({txt:t, date: new Date().toLocaleDateString()}); document.getElementById("gunlukIn").value=""; }
        }
        
        function gunlukYukle() {
            getRef('gunluk').on('child_added', s => {
                let d = s.val();
                let id = s.key;
                let html = `
                <div class="item-card" style="display:block;">
                    <div style="display:flex; justify-content:space-between;">
                        <b>üìÖ ${d.date}</b>
                        <button class="btn btn-yesil" style="padding:2px 10px; font-size:12px;" onclick="toggleOku('${id}')">Oku</button>
                    </div>
                    <div id="g_${id}" class="gizli" style="margin-top:10px; border-top:1px solid #ccc; padding-top:5px;">
                        ${d.txt}
                    </div>
                </div>`;
                document.getElementById("gunlukList").insertAdjacentHTML('afterbegin', html);
            });
        }
        
        // HTML'den eri≈üim i√ßin
        window.toggleOku = function(id) {
            document.getElementById("g_"+id).classList.toggle("gizli");
        }

        // --- Dƒ∞ƒûER VERƒ∞LER ---
        function yukleVeriler() {
            gunlukYukle();
            
            getRef('notlar').on('child_added', s => {
                let d = s.val();
                let renk = d.sonuc >= 50 ? 'basarili' : 'basarisiz';
                document.getElementById("notListesi").innerHTML += `<div class="item-card ${renk}"><b>${d.ders}</b>: Ort: ${d.sonuc}</div>`;
            });

            getRef('todo').on('child_added', s => {
                let d = s.val();
                if(!document.getElementById("gorev_"+s.key)){
                    let icon = d.durum==='basarili' ? '‚úÖ' : (d.durum==='basarisiz' ? '‚ùå' : '‚è≥');
                    let stil = d.durum==='basarili' ? 'basarili' : (d.durum==='basarisiz' ? 'basarisiz' : '');
                    document.getElementById("todoList").innerHTML += `<div id="gorev_${s.key}" class="item-card ${stil}"><span>${d.txt} (${d.sure}sn)</span> ${icon}</div>`;
                }
            });
            
            programTabloOlustur();
        }

        // --- ZAMANLI G√ñREVLER (SAYIMLI) ---
        function gorevEkle() {
            let t = document.getElementById("todoIn").value;
            let s = parseInt(document.getElementById("todoTime").value);
            if(!t || !s) return;
            
            let ref = getRef('todo').push();
            ref.set({txt:t, sure:s, durum:'bekliyor'});
            
            document.getElementById("todoIn").value="";
            document.getElementById("todoTime").value="";
            
            baslatGorevSayaci(ref.key, t, s);
        }

        function baslatGorevSayaci(key, txt, sure) {
            let div = document.createElement("div");
            div.id = "temp_" + key;
            div.className = "item-card";
            div.style.borderLeftColor = "#f1c40f";
            div.innerHTML = `<span>${txt}</span> <b id="cnt_${key}">${sure}</b> <button class="btn btn-yesil" onclick="gorevSonuc('${key}', 'basarili')">Bitir</button>`;
            document.getElementById("todoList").prepend(div);

            let interval = setInterval(() => {
                sure--;
                let el = document.getElementById("cnt_"+key);
                if(el) el.innerText = sure;
                
                if(sure <= 0) {
                    clearInterval(interval);
                    gorevSonuc(key, 'basarisiz');
                }
                if(!document.getElementById("temp_"+key)) clearInterval(interval);
            }, 1000);
        }

        window.gorevSonuc = function(key, durum) {
            let div = document.getElementById("temp_"+key);
            if(div) div.remove();
            getRef('todo/'+key).update({durum: durum});
        }

        // --- POMODORO ---
        let pomoInt = null, pomoKalan = 0, pomoDurum = false;
        function dersBaslat(dk) {
            clearInterval(pomoInt);
            pomoKalan = dk * 60;
            pomoDurum = true;
            document.getElementById("pomoDurBtn").innerText = "Durdur";
            baslatSayac();
        }
        function baslatSayac() {
            clearInterval(pomoInt);
            pomoInt = setInterval(() => {
                pomoKalan--;
                let m = Math.floor(pomoKalan/60), s = pomoKalan%60;
                document.getElementById("pomoSure").innerText = `${m}:${s<10?'0':''}${s}`;
                if(pomoKalan<=0) { clearInterval(pomoInt); alert("S√ºre Bitti!"); }
            }, 1000);
        }
        function pomoDuraklat() {
            if(pomoKalan <= 0) return;
            if(pomoDurum) {
                clearInterval(pomoInt);
                pomoDurum = false;
                document.getElementById("pomoDurBtn").innerText = "Devam Et";
            } else {
                pomoDurum = true;
                document.getElementById("pomoDurBtn").innerText = "Durdur";
                baslatSayac();
            }
        }

        // --- SOHBET ---
        function baslatSohbet() {
            database.ref('chat').on('child_added', s => {
                let m = s.val();
                let stil = m.u === user ? "background:#6c5ce7; color:white; margin-left:auto;" : "background:#eee; color:black;";
                document.getElementById("chatArea").innerHTML += `<div style="padding:8px; margin:5px; border-radius:10px; width:fit-content; max-width:80%; ${stil}"><b>${m.u}:</b> ${m.t}</div>`;
                document.getElementById("chatArea").scrollTop = document.getElementById("chatArea").scrollHeight;
            });
        }
        function chatYolla() {
            let t = document.getElementById("chatIn").value;
            if(t) { database.ref('chat').push({u:user, t:t}); document.getElementById("chatIn").value=""; }
        }

        // --- NOT VE PROGRAM ---
        function notHesapla() {
            let d=document.getElementById("dersAdi").value, v=Number(document.getElementById("vizeNot").value), f=Number(document.getElementById("finalNot").value);
            if(d) { getRef('notlar').push({ders:d, sonuc:((v*0.4)+(f*0.6)).toFixed(1)}); }
        }
        function programTabloOlustur() {
            let t = document.querySelector("#programTablosu tbody"); t.innerHTML = "";
            let s = ["09:00", "10:00", "11:00", "13:00", "14:00"];
            getRef('program').once('value', sn => {
                let data = sn.val() || {};
                s.forEach((saat, idx) => {
                    let tr = document.createElement("tr"); tr.innerHTML = `<td><b>${saat}</b></td>`;
                    for(let i=0; i<5; i++) {
                        let val = data[`d_${idx}_${i}`] || "";
                        tr.innerHTML += `<td><input class="ders-input" id="d_${idx}_${i}" value="${val}"></td>`;
                    }
                    t.appendChild(tr);
                });
            });
        }
        function programKaydet() {
            let v = {}; document.querySelectorAll(".ders-input").forEach(i => v[i.id]=i.value);
            getRef('program').set(v).then(()=>alert("Program Kaydedildi!"));
        }
        function sayfaGec(id) { 
            document.querySelectorAll(".page").forEach(p=>p.classList.remove("active")); 
            document.querySelectorAll(".menu-item").forEach(m=>m.classList.remove("active"));
            document.getElementById(id).classList.add("active"); 
            event.currentTarget.classList.add("active");
        }
    </script>
</body>
</html>
