<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ã–ÄŸrenci PortalÄ±m v18.0</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap');

        :root { --primary: #6c5ce7; --secondary: #a29bfe; --bg: #dfe6e9; --panel: #fff; --text: #2d3436; --danger: #d63031; --success: #00b894; --sidebar-bg: rgba(0,0,0,0.03); }
        
        body.koyu-mod { 
            --primary: #a29bfe; --secondary: #6c5ce7; 
            --panel: #2d3436; --text: #dfe6e9; 
            --sidebar-bg: rgba(255,255,255,0.05);
        }
        
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            margin: 0; height: 100vh; display: flex; justify-content: center; align-items: center; color: var(--text); 
            transition: background 0.5s;
        }

        body.koyu-mod {
            background: linear-gradient(-45deg, #2c3e50, #000000, #434343);
            background-size: 400% 400%;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .container { background: var(--panel); border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: hidden; transition: 0.3s; }
        
        .auth-box { 
            padding: 50px 40px; width: 380px; text-align: center;
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border-radius: 20px; border: 1px solid rgba(255, 255, 255, 0.18); color: white; 
        }
        .auth-box input { background: rgba(255, 255, 255, 0.9); border: none; padding: 15px; margin-bottom: 15px; border-radius: 30px; width: 100%; box-sizing: border-box; outline: none; transition: 0.3s; }
        .auth-box input:focus { transform: scale(1.05); }
        .auth-box button { background: linear-gradient(to right, #6c5ce7, #a29bfe); border: none; padding: 15px; border-radius: 30px; width: 100%; color: white; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .auth-box button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .app-box { width: 1200px; height: 800px; display: flex; background: var(--panel); }
        
        @media screen and (max-width: 768px) {
            .app-box { flex-direction: column; width: 100%; height: 100%; }
            .sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; }
            .content { padding: 15px; }
            #myBoard { width: 300px !important; }
            .auth-box { width: 90%; }
        }

        .sidebar { width: 240px; background: var(--sidebar-bg); padding: 20px; display: flex; flex-direction: column; gap: 8px; border-right: 1px solid rgba(0,0,0,0.05); }
        .content { flex: 1; padding: 30px; overflow-y: auto; }
        
        .menu-item { padding: 12px; cursor: pointer; border-radius: 10px; display: flex; align-items: center; gap: 10px; transition: 0.2s; font-size: 14px; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; transform: translateX(5px); box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }
        
        .page { display: none; } .page.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        input, button, textarea, select { width: 100%; padding: 10px; margin: 5px 0; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; font-family: 'Poppins', sans-serif;}
        body.koyu-mod input, body.koyu-mod textarea, body.koyu-mod select { background: rgba(255,255,255,0.1); color: white; border: 1px solid #444; }
        .gizli { display: none !important; }

        .item-card { background: rgba(0,0,0,0.03); padding: 15px; margin-bottom: 10px; border-radius: 10px; border-left: 5px solid var(--secondary); display: flex; justify-content: space-between; align-items: center; transition: 0.3s; }
        body.koyu-mod .item-card { background: rgba(255,255,255,0.05); }
        .basarili { border-left-color: var(--success); background: rgba(0, 184, 148, 0.1); opacity: 0.9; }
        .basarisiz { border-left-color: var(--danger); background: rgba(214, 48, 49, 0.1); opacity: 0.9; }
        
        #myBoard { margin: 0 auto; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); border-radius: 5px; }
        .timers { display: flex; justify-content: space-between; width: 400px; margin: 0 auto 15px auto; font-size: 18px; font-weight: 600; }
        .timer-box { padding: 8px 20px; border-radius: 8px; background: #f1f2f6; min-width: 90px; text-align: center; transition: 0.3s; border: 2px solid transparent; color: #333;}
        .timer-active { background: white; border-color: var(--primary); color: var(--primary); box-shadow: 0 0 15px rgba(108, 92, 231, 0.2); transform: scale(1.05); }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #eee; padding: 10px; text-align: center; font-size: 13px; }
        body.koyu-mod th, body.koyu-mod td { border-color: #444; }
        th { background: rgba(0,0,0,0.05); }
        body.koyu-mod th { background: rgba(255,255,255,0.05); }
        .ders-input { border: none; background: transparent; text-align: center; width: 100%; outline: none; color: inherit; }

        #beklemeEkrani {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 99;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        body.koyu-mod #beklemeEkrani { background: rgba(30,30,30,0.95); }
        .spinner { border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #geriSayimText { font-size: 80px; font-weight: bold; color: var(--primary); animation: pop 0.5s ease; }
        @keyframes pop { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }

        .dashboard-card { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 20px; border-radius: 15px; flex: 1; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); margin: 10px; }
        .dashboard-card h3 { font-size: 36px; margin: 10px 0; }
        .dashboard-container { display: flex; flex-wrap: wrap; justify-content: space-between; }

        .pomodoro-circle { width: 200px; height: 200px; border-radius: 50%; border: 5px solid var(--primary); display: flex; justify-content: center; align-items: center; font-size: 40px; font-weight: bold; margin: 20px auto; color: var(--primary); }
    </style>
</head>
<body>

    <div id="authScreen" class="auth-box">
        <h2 style="font-size: 28px; margin-bottom: 20px;"><i class="fas fa-graduation-cap"></i> Ã–ÄŸrenci PortalÄ±</h2>
        <input type="text" id="kAdi" placeholder="KullanÄ±cÄ± AdÄ±">
        <input type="password" id="sifre" placeholder="Åifre">
        <button onclick="islemYap()">GiriÅŸ Yap</button>
        <p onclick="modDegistir()" style="cursor:pointer; font-size:13px; margin-top:15px; text-decoration: underline;">HesabÄ±n yok mu? KayÄ±t Ol</p>
    </div>

    <div id="appScreen" class="container app-box gizli">
        <div class="sidebar">
            <h3 style="text-align:center; color: var(--primary); margin-top: 0;"><i class="fas fa-cube"></i> MenÃ¼</h3>
            <div class="menu-item active" onclick="sayfaGec('dashboard')"><i class="fas fa-home"></i> Ana Sayfa</div>
            <div class="menu-item" onclick="sayfaGec('pomodoro')"><i class="fas fa-clock"></i> Ders Ã‡alÄ±ÅŸma</div>
            <div class="menu-item" onclick="sayfaGec('oyunlar')"><i class="fas fa-chess-king"></i> Arena (Online)</div>
            <div class="menu-item" onclick="sayfaGec('todo')"><i class="fas fa-stopwatch"></i> ZamanlÄ± GÃ¶revler</div>
            <div class="menu-item" onclick="sayfaGec('notlar')"><i class="fas fa-calculator"></i> Not Hesapla</div>
            <div class="menu-item" onclick="sayfaGec('program')"><i class="fas fa-calendar-alt"></i> Ders ProgramÄ±</div>
            <div class="menu-item" onclick="sayfaGec('gunluk')"><i class="fas fa-book"></i> GÃ¼nlÃ¼ÄŸÃ¼m</div>
            <div class="menu-item" onclick="sayfaGec('sohbet')"><i class="fas fa-comments"></i> Sohbet (CanlÄ±)</div>
            <div class="menu-item" onclick="sayfaGec('iletisim')"><i class="fas fa-envelope"></i> Åikayet/Ã–neri</div>
            
            <div style="margin-top:auto; text-align:center;">
                <p id="karsilama" style="font-size:14px; font-weight:bold;"></p>
                <div style="background: rgba(255,255,255,0.1); padding: 5px; margin-bottom: 5px; border-radius: 5px;">
                    <button onclick="yedekIndir()" style="width:100%; font-size:11px; background:#00b894; border:none; padding:5px; color:white; border-radius:3px; cursor:pointer;">ğŸ’¾ Yedek Ä°ndir</button>
                    <input type="file" id="yedekYukleInput" style="display:none" onchange="yedekYukle(this)">
                    <button onclick="document.getElementById('yedekYukleInput').click()" style="width:100%; font-size:11px; background:#0984e3; border:none; padding:5px; color:white; border-radius:3px; cursor:pointer; margin-top:5px;">ğŸ“‚ Yedek YÃ¼kle</button>
                </div>
                <button onclick="koyuModToggle()" style="background:#2d3436; color:white; padding:8px; font-size:12px; margin-top:10px; border:none; width:100%; border-radius:5px;">ğŸŒ— Mod DeÄŸiÅŸtir</button>
                <button onclick="location.reload()" style="background:#ff7675; color:white; padding:8px; font-size:12px; margin-top:5px; border:none; width:100%; border-radius:5px;">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
        </div>

        <div class="content">
            
            <div id="dashboard" class="page active">
                <h2>ğŸ‘‹ HoÅŸgeldin, <span id="dashUser"></span></h2>
                <p>Ä°ÅŸte bugÃ¼nkÃ¼ durum Ã¶zetin:</p>
                <div class="dashboard-container">
                    <div class="dashboard-card" style="background: linear-gradient(135deg, #6c5ce7, #a29bfe);">
                        <i class="fas fa-chess-king" style="font-size:24px;"></i><h3 id="dashPuan">0</h3><span>SatranÃ§ PuanÄ±</span>
                    </div>
                    <div class="dashboard-card" style="background: linear-gradient(135deg, #00b894, #55efc4);">
                        <i class="fas fa-check-circle" style="font-size:24px;"></i><h3 id="dashGorev">0</h3><span>Bekleyen GÃ¶rev</span>
                    </div>
                    <div class="dashboard-card" style="background: linear-gradient(135deg, #e17055, #fab1a0);">
                        <i class="fas fa-book" style="font-size:24px;"></i><h3 id="dashGunluk">0</h3><span>GÃ¼nlÃ¼k SayfasÄ±</span>
                    </div>
                </div>
            </div>

            <div id="pomodoro" class="page" style="text-align:center;">
                <h2>ğŸ… Derse Odaklanma</h2>
                <p>25 Dakika Ders, 5 Dakika Mola</p>
                <div class="pomodoro-circle" id="pomoSure">25:00</div>
                <div style="margin-top:20px;">
                    <button onclick="dersBaslat()" style="width:auto; background:var(--primary); color:white; border:none; padding:10px 20px;">Ders BaÅŸlat (25dk)</button>
                    <button onclick="molaBaslat()" style="width:auto; background:var(--success); color:white; border:none; padding:10px 20px;">Mola Ver (5dk)</button>
                    <button id="btnPomoDur" onclick="durdurToggle()" style="width:auto; background:var(--danger); color:white; border:none; padding:10px 20px;">Durdur</button>
                </div>
            </div>

            <div id="oyunlar" class="page" style="position: relative;">
                <div id="beklemeEkrani" class="gizli">
                    <div id="beklemeIcerik" style="text-align: center;">
                        <div class="spinner"></div><h2 id="beklemeYazisi">RAKÄ°P BEKLENÄ°YOR...</h2><p>BaÅŸka bir kullanÄ±cÄ± baÄŸlanana kadar bekleyin.</p>
                        <button onclick="beklemeyiIptalEt()" style="background:#d63031; color:white; border:none; width:auto; padding:10px 20px;">Ä°ptal</button>
                    </div>
                    <div id="geriSayimIcerik" class="gizli" style="text-align: center;">
                        <h2>RAKÄ°P BULUNDU!</h2><p>Oyun baÅŸlÄ±yor...</p><div id="geriSayimText">5</div>
                    </div>
                </div>
                <h2 style="text-align:center; color: var(--primary);">â™Ÿï¸ SatranÃ§</h2>
                <div style="display:flex; justify-content:center; gap:15px; margin-bottom:25px;">
                    <button onclick="oyunModuSec('bot')" style="width:auto; background:#b2bec3; border:none; color:white;">ğŸ¤– Antrenman (Bot)</button>
                    <button onclick="dereceliGir()" style="width:auto; background: linear-gradient(to right, #ff9f43, #ee5253); border:none; color:white; box-shadow: 0 4px 15px rgba(238, 82, 83, 0.4);">ğŸ”¥ Dereceli (+250 Puan)</button>
                </div>
                <div id="oyunAlani" class="gizli">
                    <div class="timers"><div id="timerW" class="timer-box">Beyaz: 10:00</div><div id="timerB" class="timer-box">Siyah: 10:00</div></div>
                    <div style="text-align:center; font-weight:bold; margin-bottom:10px;" id="oyunDurum">Hamle SÄ±rasÄ±: Beyaz</div>
                    <div id="myBoard"></div>
                    <div style="text-align:center; margin-top:20px;">
                        <button onclick="pesEt()" style="width:auto; background:#d63031; color:white; border:none;">Oyunu Bitir / Pes Et</button>
                    </div>
                </div>
                <div id="lobiAlani" style="text-align:center; padding:20px;"><h3>Lobiye HoÅŸgeldin</h3><p>Rakibini beklemek istemiyorsan hemen bir mod seÃ§.</p></div>
            </div>

            <div id="todo" class="page">
                <h2>â±ï¸ ZamanlÄ± GÃ¶rev Listesi</h2>
                <div style="display:flex; gap:10px;">
                    <input id="todoIn" placeholder="GÃ¶rev nedir?"><input type="number" id="todoTime" placeholder="Sn" style="width:80px;" min="1" oninput="this.value = this.value.replace(/[^0-9.]/g, '').replace(/(\..*?)\..*/g, '$1');">
                    <button onclick="gorevEkle()" style="width:80px; background:var(--success); color:white; border:none;">BaÅŸlat</button>
                </div>
                <div id="todoList" style="margin-top:20px;"></div>
            </div>

            <div id="notlar" class="page">
                <h2>ğŸ§® Vize / Final Hesapla</h2>
                <div style="display:flex; gap:10px; align-items:center;">
                    <input id="dersAdi" placeholder="Ders AdÄ±"><input id="vizeNot" type="number" placeholder="Vize (%40)" style="width:100px;"><input id="finalNot" type="number" placeholder="Final (%60)" style="width:100px;">
                    <button onclick="notHesapla()" style="width:100px; background:var(--primary); color:white; border:none;">Hesapla</button>
                </div>
                <div id="notListesi" style="margin-top:20px;"></div>
            </div>

            <div id="program" class="page">
                <h2>ğŸ“… HaftalÄ±k Ders ProgramÄ±</h2><p style="font-size:12px; opacity:0.7;">Dersleri kutulara yaz ve Kaydet'e bas. Hepsi hafÄ±zada kalÄ±r.</p>
                <table id="programTablosu"><thead><tr><th>Saat</th><th>Pzt</th><th>Sal</th><th>Ã‡ar</th><th>Per</th><th>Cum</th></tr></thead><tbody></tbody></table>
                <button onclick="programKaydet()" style="margin-top:10px; width:auto; background:var(--success); color:white; border:none;">ğŸ’¾ ProgramÄ± Kaydet</button>
            </div>

            <div id="gunluk" class="page">
                <h2>ğŸ“” GÃ¼nlÃ¼k</h2><textarea id="gunlukIn" rows="5" maxlength="2000" placeholder="BugÃ¼n neler yaÅŸadÄ±n? (Max 2000 karakter)"></textarea>
                <button onclick="gunlukEkle()" style="background:var(--secondary); color:white; border:none;">GÃ¼nlÃ¼ÄŸe Yaz</button>
                <div id="gunlukList" style="margin-top:20px;"></div>
            </div>

            <div id="sohbet" class="page">
                <h2>ğŸ’¬ Sohbet OdasÄ± (GÃ¼nlÃ¼k SÄ±fÄ±rlanÄ±r)</h2>
                <div id="chatArea" style="height:400px; overflow-y:scroll; border:1px solid #eee; padding:15px; border-radius:10px; margin-bottom:10px;"></div>
                <div style="display:flex; gap:10px;"><input id="chatIn" placeholder="MesajÄ±nÄ± yaz..."><button onclick="chatYolla()" style="width:80px; background:var(--primary); color:white; border:none;">Yolla</button></div>
            </div>

            <div id="iletisim" class="page">
                <h2>ğŸ“¬ Åikayet ve Ã–neri</h2>
                <select id="oneriTur"><option value="Ã–neri">Ã–neri</option><option value="Åikayet">Åikayet</option></select>
                <input id="oneriKonu" placeholder="Konu"><textarea id="oneriMesaj" rows="4" placeholder="MesajÄ±nÄ±z..."></textarea>
                <button onclick="oneriYolla()" style="background:#e17055; color:white; border:none;">ğŸ“§ Kaydet ve E-Posta GÃ¶nder</button>
                <div id="oneriList" style="margin-top:20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // --- BURAYI KENDÄ° BÄ°LGÄ°LERÄ°NLE DOLDUR ---
const firebaseConfig = {
  "apiKey": "AIzaSysH1Dxw7Ll1733UKZTGEWt9qUvI4VvdyFw",
  "authDomain": "portal-.firebaseapp.com",
  "projectId": "portal-",
  "storageBucket": "portal-.appspot.com",
  "messagingSenderId": "495203320109",
  "appId": "1:861417473624:web:f24oKV",
  "measurementId": "G-7WKTYEVACX"
};
        // ----------------------------------------

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let user = null, kayit = false;
        let board = null, game = new Chess();
        let aktifMod = null;
        let wTime = 600, bTime = 600, timerInterval = null;
        let myColor = 'w'; 
        let pomoInterval = null, pomoKalan = 0, pomoDurum = false, pomoMod = ""; 

        if(localStorage.getItem("koyuMod") === "1") document.body.classList.add("koyu-mod");

        function modDegistir() { kayit=!kayit; document.querySelector("#authScreen h2").innerText=kayit?"KayÄ±t Ol":"Ã–ÄŸrenci PortalÄ±"; }
        function islemYap() {
            let k=document.getElementById("kAdi").value, s=document.getElementById("sifre").value;
            if(!k||!s) return alert("BoÅŸ bÄ±rakma!");
            if(kayit) {
                if(localStorage.getItem("u_"+k)) return alert("Bu kullanÄ±cÄ± adÄ± alÄ±nmÄ±ÅŸ!");
                localStorage.setItem("u_"+k, s); localStorage.setItem("puan_"+k, 0); alert("KayÄ±t BaÅŸarÄ±lÄ±!"); modDegistir();
            } else {
                if(localStorage.getItem("u_"+k)==s) {
                    user=k; document.getElementById("authScreen").classList.add("gizli");
                    document.getElementById("appScreen").classList.remove("gizli");
                    document.getElementById("karsilama").innerText="ğŸ‘¤ "+user;
                    yukle();
                    baslatSohbetDinleyici();
                } else alert("HatalÄ± kullanÄ±cÄ± adÄ± veya ÅŸifre!");
            }
        }
        function sayfaGec(id) { document.querySelectorAll(".page").forEach(p=>p.classList.remove("active")); document.querySelectorAll(".menu-item").forEach(m=>m.classList.remove("active")); document.getElementById(id).classList.add("active"); event.currentTarget.classList.add("active"); yukle(); }
        function koyuModToggle() { document.body.classList.toggle("koyu-mod"); localStorage.setItem("koyuMod", document.body.classList.contains("koyu-mod") ? "1" : "0"); }
        function getVeri(key) { return JSON.parse(localStorage.getItem(key+"_"+user)||"[]"); }
        function setVeri(key, val) { localStorage.setItem(key+"_"+user, JSON.stringify(val)); }

        function yukle() {
            let puan = localStorage.getItem("puan_"+user)||"0";
            let gorevler = getVeri("todo");
            let gunlukler = getVeri("gunluk");
            document.getElementById("dashUser").innerText = user; document.getElementById("dashPuan").innerText = puan;
            document.getElementById("dashGorev").innerText = gorevler.filter(g => g.durum === 'bekliyor').length;
            document.getElementById("dashGunluk").innerText = gunlukler.length;

            let nl = document.getElementById("notListesi"); nl.innerHTML="";
            getVeri("notlar").forEach((x,i) => { nl.innerHTML+=`<div class="item-card ${x.sonuc>=50?'basarili':'basarisiz'}"><b>${x.ders}</b>: Ort: ${x.sonuc} <button onclick="sil('notlar',${i})" style="background:white;color:black;border:none;">Sil</button></div>`; });

            let gl = document.getElementById("gunlukList"); gl.innerHTML="";
            gunlukler.forEach((x, i) => {
                gl.innerHTML += `<div class="item-card" style="display:block"><div style="display:flex;justify-content:space-between;"><b>GÃ¼n ${gunlukler.length-i}</b><div><button onclick="gunlukAc(${i})" style="margin-right:5px;background:var(--primary);color:white;border:none;">Oku</button><button onclick="gunlukSil(${i})" style="background:#d63031;color:white;border:none;">Sil</button></div></div><div id="g_detay_${i}" class="gizli" style="margin-top:10px;border-top:1px solid #ccc;">${x.txt}</div></div>`;
            });

            let ol = document.getElementById("oneriList"); ol.innerHTML="";
            getVeri("oneri").forEach(x => ol.innerHTML+=`<div class="item-card" style="display:block"><b>${x.tur}</b>: ${x.konu}<br><small>${x.msg}</small></div>`);
            
            let tl = document.getElementById("todoList"); tl.innerHTML="";
            gorevler.forEach((g, index) => {
                let btn = g.durum === 'bekliyor' ? `<button onclick="gorevSil(${index})" style="background:#d63031;color:white;border:none;">Sil</button>` : `<button onclick="gorevSil(${index})" style="background:white;color:black;border:none;">Sil</button>`;
                tl.innerHTML += `<div class="item-card ${g.durum==='basarili'?'basarili':(g.durum==='basarisiz'?'basarisiz':'')}"><span>${g.txt} (${g.s} sn)</span> <span>${g.durum==='basarili'?'âœ…':(g.durum==='basarisiz'?'âŒ':'â³')}</span> ${btn}</div>`;
            });
            programTabloOlustur();
        }

        function sil(k, i) { let d=getVeri(k); d.splice(i,1); setVeri(k,d); yukle(); }
        function gorevSil(i) { sil("todo",i); }
        function gorevEkle() {
            let t = document.getElementById("todoIn").value, s = parseInt(document.getElementById("todoTime").value);
            if(!t || !s) return;
            let d = getVeri("todo"); d.unshift({ txt: t, s: s, durum: 'bekliyor' }); setVeri("todo", d);
            document.getElementById("todoIn").value=""; document.getElementById("todoTime").value=""; yukle(); baslatGorevTimer(0, s); 
        }
        function baslatGorevTimer(idx, sure) {
            let tl = document.getElementById("todoList"), div = tl.children[0]; 
            div.innerHTML = `<span>${getVeri("todo")[0].txt}</span> <span id="sayacSpan">â³ ${sure}</span> <button id="bitirBtn" style="background:#00b894;color:white;border:none;">Bitir</button>`;
            let sayac = setInterval(() => { sure--; div.querySelector("#sayacSpan").innerText = `â³ ${sure}`; if(sure <= 0) { clearInterval(sayac); guncelleGorevDurumu(0,'basarisiz'); } }, 1000);
            div.querySelector("#bitirBtn").onclick = () => { clearInterval(sayac); guncelleGorevDurumu(0,'basarili'); }
        }
        function guncelleGorevDurumu(i, d) { let data=getVeri("todo"); if(data[i]){ data[i].durum=d; setVeri("todo",data); yukle(); } }
        
        function notHesapla() {
            let d=document.getElementById("dersAdi").value, v=Number(document.getElementById("vizeNot").value), f=Number(document.getElementById("finalNot").value);
            if(d) { let veri=getVeri("notlar"); veri.push({ders:d, sonuc:((v*0.4)+(f*0.6)).toFixed(1)}); setVeri("notlar", veri); yukle(); }
        }
        function gunlukEkle() { let t=document.getElementById("gunlukIn").value; if(t) { let d=getVeri("gunluk"); d.unshift({t:new Date().toLocaleDateString(), txt:t}); setVeri("gunluk",d); document.getElementById("gunlukIn").value=""; yukle(); } }
        function gunlukAc(i) { document.getElementById("g_detay_"+i).classList.toggle("gizli"); }
        function gunlukSil(i) { sil("gunluk",i); }
        
        function oneriYolla() { 
            let t=document.getElementById("oneriTur").value, k=document.getElementById("oneriKonu").value, m=document.getElementById("oneriMesaj").value;
            if(!k||!m) return alert("Doldur!");
            let d=getVeri("oneri"); d.unshift({tur:t, konu:k, msg:m}); setVeri("oneri",d);
            window.location.href = `mailto:mustafasoylemez2000@gmail.com?subject=[${t}] ${k} - ${user}&body=GÃ¶nderen: ${user}%0D%0A%0D%0A${m}`;
            document.getElementById("oneriKonu").value=""; document.getElementById("oneriMesaj").value=""; yukle(); 
        }

        function programTabloOlustur() {
            let t = document.querySelector("#programTablosu tbody"); t.innerHTML = "";
            let s = ["09:00", "10:00", "11:00", "13:00", "14:00"], k = JSON.parse(localStorage.getItem("program_"+user) || "{}");
            s.forEach((saat, idx) => {
                let tr = document.createElement("tr"); tr.innerHTML = `<td><b>${saat}</b></td>`;
                for(let i=0; i<5; i++) tr.innerHTML += `<td><input type="text" class="ders-input" id="d_${idx}_${i}" value="${k['d_'+idx+'_'+i]||''}" placeholder="..."></td>`;
                t.appendChild(tr);
            });
        }
        function programKaydet() {
            let v = {}; document.querySelectorAll(".ders-input").forEach(i => { if(i.value) v[i.id]=i.value; });
            localStorage.setItem("program_"+user, JSON.stringify(v)); alert("Kaydedildi!");
        }

        function dersBaslat() { if(pomoMod==='mola' && pomoKalan>0 && !confirm("Mola bitmedi?")) return; if(pomoMod==='ders'&&pomoKalan>0&&!pomoDurum) {sayacBaslat();return;} pomoMod='ders';pomoKalan=25*60;sayacBaslat(); }
        function molaBaslat() { if(pomoMod==='ders' && pomoKalan>0) return alert("Ders bitmedi!"); if(pomoMod==='mola'&&pomoKalan>0&&!pomoDurum) {sayacBaslat();return;} pomoMod='mola';pomoKalan=5*60;sayacBaslat(); }
        function sayacBaslat() { clearInterval(pomoInterval); pomoDurum=true; document.getElementById("btnPomoDur").innerText="Durdur"; pomoInterval=setInterval(()=>{ pomoKalan--; let m=Math.floor(pomoKalan/60),s=pomoKalan%60; document.getElementById("pomoSure").innerText=`${m}:${s<10?'0':''}${s}`; if(pomoKalan<=0){clearInterval(pomoInterval);pomoDurum=false;alert("SÃ¼re bitti!");} },1000); }
        function durdurToggle() { if(pomoKalan<=0) return; if(pomoDurum){clearInterval(pomoInterval);pomoDurum=false;document.getElementById("btnPomoDur").innerText="Devam Et";}else{sayacBaslat();} }

        // --- CHESS & ONLINE ---
        function dereceliGir() {
            document.getElementById("lobiAlani").classList.add("gizli"); document.getElementById("beklemeEkrani").classList.remove("gizli");
            database.ref('lobby').once('value', snapshot => {
                let lobby = snapshot.val();
                if (!lobby || lobby.status === 'empty') {
                    database.ref('lobby').set({ status: 'waiting', p1: user });
                    myColor = 'w';
                    database.ref('lobby').on('child_changed', s => { if(s.val()==='ready') baslatGeriSayim(); });
                } else if (lobby.status === 'waiting') {
                    database.ref('lobby').update({ status: 'ready', p2: user });
                    myColor = 'b';
                    baslatGeriSayim();
                } else { alert("Dolu!"); beklemeyiIptalEt(); }
            });
        }
        function beklemeyiIptalEt() { 
            database.ref('lobby').get().then(s => { if(s.val()?.p1===user) database.ref('lobby').set({status:'empty'}); });
            document.getElementById("beklemeEkrani").classList.add("gizli"); document.getElementById("lobiAlani").classList.remove("gizli");
        }
        function baslatGeriSayim() {
            document.getElementById("beklemeIcerik").classList.add("gizli"); document.getElementById("geriSayimIcerik").classList.remove("gizli");
            let c=5, i=setInterval(()=>{ c--; document.getElementById("geriSayimText").innerText=c; if(c<=0){ clearInterval(i); document.getElementById("beklemeEkrani").classList.add("gizli"); oyunModuSec('online_start'); } },1000);
        }
        function oyunModuSec(mod) {
            aktifMod = mod==='online_start'?'online':mod; document.getElementById("lobiAlani").classList.add("gizli"); document.getElementById("oyunAlani").classList.remove("gizli");
            game.reset(); 
            if(aktifMod==='online') { 
                document.getElementById("oyunDurum").innerText="DERECELÄ° (Sen: "+(myColor=='w'?'Beyaz':'Siyah')+")"; 
                startClock();
                database.ref('game').on('value', s => {
                    let v = s.val(); if(v && v.fen !== game.fen()) { game.load(v.fen); board.position(v.fen); tahtaGuncelle(false); }
                });
            } else document.getElementById("oyunDurum").innerText="ANTRENMAN";
            if(board) board.destroy();
            board = Chessboard('myBoard', { draggable: true, position: 'start', onDragStart: onDragStart, onDrop: onDrop, onSnapEnd: () => board.position(game.fen()), orientation: aktifMod==='online'&&myColor==='b'?'black':'white' });
        }
        function onDragStart(s, p) { if(game.game_over() || (aktifMod==='bot' && game.turn()==='b') || (aktifMod==='online' && game.turn()!==myColor)) return false; }
        function onDrop(s, t) {
            let m = game.move({ from: s, to: t, promotion: 'q' }); if(m===null) return 'snapback';
            tahtaGuncelle(true);
            if(aktifMod==='bot') setTimeout(()=>{ game.move(game.moves()[Math.floor(Math.random()*game.moves().length)]); board.position(game.fen()); tahtaGuncelle(true); },250);
            else if(aktifMod==='online') database.ref('game').set({ fen: game.fen(), turn: game.turn() });
        }
        function tahtaGuncelle(gonderenBenim) {
            updateTimerUI();
            if(game.game_over()) {
                if(game.in_checkmate()) {
                    let k = game.turn()==='w'?'Siyah':'Beyaz';
                    alert("KAZANAN: " + k);
                    if(aktifMod==='online') {
                        if(k===(myColor=='w'?'Beyaz':'Siyah')) puanIsle(250); else puanIsle(-100);
                        database.ref('lobby').set({status:'empty'});
                    }
                }
            }
        }
        function puanIsle(m) { let p=parseInt(localStorage.getItem("puan_"+user)||"0")+m; localStorage.setItem("puan_"+user,p); document.getElementById("kullaniciPuani").innerText=p; oyundanCik(); }
        function pesEt() { if(aktifMod==='online') puanIsle(-200); else oyundanCik(); }
        function oyundanCik() { clearInterval(timerInterval); document.getElementById("oyunAlani").classList.add("gizli"); document.getElementById("lobiAlani").classList.remove("gizli"); game.reset(); }
        
        function updateTimerUI() { /* Basitlik iÃ§in timer gÃ¶rseli sabit kalsÄ±n */ }
        function startClock() { /* Online senkronizasyon karmaÅŸÄ±k, ÅŸimdilik gÃ¶rsel */ }

        // --- ONLINE SOHBET ---
        function baslatSohbetDinleyici() {
            // Sadece bugÃ¼nÃ¼n mesajlarÄ±nÄ± gÃ¶ster
            let bugun = new Date().toLocaleDateString();
            database.ref('chat').on('child_added', s => {
                let m = s.val();
                // EÄŸer mesajÄ±n tarihi bugÃ¼ne eÅŸitse ekrana bas, deÄŸilse basma
                if(m.tarih === bugun) {
                    let div = `<div style="margin:5px;padding:5px;border-radius:5px;background:${m.u===user?'var(--primary)':'#eee'};color:${m.u===user?'white':'black'};width:fit-content;margin-left:${m.u===user?'auto':'0'}"><b>${m.u}:</b> ${m.t}</div>`;
                    document.getElementById("chatArea").innerHTML += div;
                    document.getElementById("chatArea").scrollTop = document.getElementById("chatArea").scrollHeight;
                }
            });
        }
        function chatYolla() {
            let t = document.getElementById("chatIn").value; if(!t) return;
            // MesajÄ± atarken bugÃ¼nÃ¼n tarihini de ekle
            database.ref('chat').push({ u: user, t: t, tarih: new Date().toLocaleDateString() });
            document.getElementById("chatIn").value = "";
        }

        function yedekIndir() {
            let a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(localStorage)], {type: "application/json"})); a.download = "yedek.json"; a.click();
        }
        function yedekYukle(input) {
            let r = new FileReader(); r.onload = e => { let d=JSON.parse(e.target.result); for(let k in d) localStorage.setItem(k,d[k]); location.reload(); }; r.readAsText(input.files[0]);
        }
    </script>
</body>
</html>