<!DOCTYPE html>
<html lang="tr">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>√ñƒürenci Portalƒ±m v27.0</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* --- FONTLAR VE TEMEL AYARLAR --- */
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap');
        
        :root { --primary: #6c5ce7; --primary-dark: #5649c0; --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%); --panel: #ffffff; --text: #2d3436; --success: #00b894; --danger: #ff7675; }
        body.koyu-mod { --primary: #a29bfe; --panel: #2d3436; --text: #dfe6e9; --bg-gradient: linear-gradient(135deg, #232526 0%, #414345 100%); }
        
        body { font-family: 'Poppins', sans-serif; background: var(--bg-gradient); margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: center; color: var(--text); overflow: hidden; transition: background 0.5s; }
        
        /* --- MOBƒ∞L UYUM --- */
        @media screen and (max-width: 768px) {
            body, .container { flex-direction: column !important; width: 100% !important; padding: 0 !important; height: 100vh !important; border-radius: 0 !important; }
            .sidebar { width: 100% !important; height: auto !important; padding: 10px !important; display: flex; overflow-x: auto; gap: 10px; border-bottom: 1px solid #eee; border-right: none !important; }
            .sidebar h3, .sidebar p, .sidebar button { display: none; } /* Mobilde ba≈ülƒ±ƒüƒ± ve √ßƒ±kƒ±≈üƒ± gizle */
            .menu-item { flex-direction: column; font-size: 10px; padding: 5px; text-align: center; min-width: 60px; }
            .menu-item i { font-size: 18px; margin-bottom: 3px; }
            .auth-box { width: 90% !important; padding: 30px 20px !important; }
            #myBoard { width: 300px !important; }
            .timers { width: 300px !important; }
            .content { padding: 15px !important; }
        }

        /* --- ANA KONTEYNER --- */
        .container { background: var(--panel); width: 1200px; height: 800px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); display: flex; overflow: hidden; position: relative; }
        
        /* --- Gƒ∞Rƒ∞≈û EKRANI (YENƒ∞ TASARIM) --- */
        .overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); z-index:999; display:flex; justify-content:center; align-items:center; }
        .auth-box { 
            padding: 50px 40px; width: 380px; text-align: center; 
            background: rgba(255, 255, 255, 0.85); 
            border-radius: 25px; 
            box-shadow: 0 15px 35px rgba(0,0,0,0.2); 
            border: 1px solid rgba(255,255,255,0.5);
            transition: transform 0.3s;
        }
        .auth-box:hover { transform: translateY(-5px); }
        .auth-box h2 { color: #333; margin-bottom: 5px; font-weight: 700; }
        .auth-box p { color: #666; font-size: 13px; margin-bottom: 25px; }
        
        .input-group { position: relative; margin-bottom: 15px; }
        .input-group input { 
            width: 100%; padding: 15px; padding-left: 20px; 
            border: 2px solid #eee; border-radius: 12px; 
            background: #f9f9f9; outline: none; font-size: 15px; transition: 0.3s; 
            box-sizing: border-box;
        }
        .input-group input:focus { border-color: var(--primary); background: #fff; box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1); }
        
        .auth-btn { 
            width: 100%; padding: 15px; border: none; border-radius: 12px; 
            background: linear-gradient(135deg, var(--primary), var(--primary-dark)); 
            color: white; font-weight: 600; font-size: 16px; cursor: pointer; 
            transition: 0.3s; box-shadow: 0 10px 20px rgba(108, 92, 231, 0.3); margin-top: 10px; 
        }
        .auth-btn:hover { transform: scale(1.02); box-shadow: 0 15px 25px rgba(108, 92, 231, 0.4); }
        .link-text { color: var(--primary); font-weight: 600; cursor: pointer; font-size: 13px; margin-top: 15px; display: block; }

        /* --- MEN√ú VE ƒ∞√áERƒ∞K --- */
        .sidebar { width: 250px; background: rgba(0,0,0,0.02); padding: 25px; display: flex; flex-direction: column; gap: 10px; border-right: 1px solid rgba(0,0,0,0.05); }
        .content { flex: 1; padding: 40px; overflow-y: auto; scroll-behavior: smooth; }
        
        .menu-item { padding: 12px 15px; cursor: pointer; border-radius: 12px; display: flex; gap: 12px; align-items: center; color: #666; font-weight: 500; transition: 0.2s; }
        .menu-item:hover { background: rgba(108, 92, 231, 0.1); color: var(--primary); }
        .menu-item.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(108, 92, 231, 0.3); }
        .menu-item i { width: 20px; text-align: center; }

        .page { display: none; animation: slideUp 0.4s ease-out; } 
        .page.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .gizli { display: none !important; }

        /* --- SATRAN√á (YENƒ∞ TASARIM) --- */
        .chess-wrapper { background: #f8f9fa; padding: 20px; border-radius: 20px; display: inline-block; box-shadow: inset 0 0 20px rgba(0,0,0,0.05); border: 1px solid #eee; }
        #myBoard { margin: 0 auto; width: 400px; border: 5px solid #4a4a4a; border-radius: 5px; }
        .timers { display: flex; justify-content: space-between; width: 400px; margin: 0 auto 15px auto; }
        .timer-box { 
            padding: 8px 15px; border-radius: 10px; background: #e0e0e0; color: #555; 
            font-family: 'Courier New', monospace; font-weight: bold; font-size: 20px; 
            border: 2px solid transparent; width: 120px; text-align: center;
        }
        .timer-active { background: #fff; border-color: var(--success); color: var(--success); box-shadow: 0 0 15px rgba(0, 184, 148, 0.4); transform: scale(1.05); transition: 0.3s; }

        /* --- KARTLAR VE ELEMANLAR --- */
        .item-card { background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; display: flex; justify-content: space-between; align-items: center; }
        .item-card:hover { transform: translateX(5px); }
        .basarili { border-left-color: var(--success); } .basarisiz { border-left-color: var(--danger); }
        
        .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; color: white; font-weight: 600; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-yesil { background: var(--success); } .btn-kirmizi { background: var(--danger); } .btn-gri { background: #636e72; }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
        input:focus, textarea:focus { border-color: var(--primary); outline: none; }

        /* Pomodoro */
        .pomodoro-circle { 
            width: 220px; height: 220px; border-radius: 50%; 
            border: 8px solid #eee; border-top-color: var(--primary); 
            display: flex; justify-content: center; align-items: center; 
            font-size: 50px; font-weight: bold; margin: 20px auto; color: var(--text); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
        }

        /* Bekleme Ekranƒ± */
        #beklemeEkrani { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.98); z-index: 99; display: flex; flex-direction: column; justify-content: center; align-items: center; border-radius: 15px; }
        .spinner { width: 60px; height: 60px; border: 6px solid #f3f3f3; border-top: 6px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="authScreen" class="overlay">
        <div class="auth-box">
            <div style="margin-bottom: 20px;">
                <i class="fas fa-graduation-cap" style="font-size: 50px; color: #6c5ce7;"></i>
            </div>
            <h2 id="authTitle">√ñƒürenci Giri≈üi</h2>
            <p>Portalƒ±na ho≈ügeldin Devam etmek i√ßin giri≈ü yap.</p>
            
            <div class="input-group">
                <input type="text" id="kAdiInput" placeholder="Kullanƒ±cƒ± Adƒ±">
            </div>
            
            <div id="emailDiv" class="input-group gizli">
                <input type="email" id="emailInput" placeholder="E-Posta Adresi (ornek@gmail.com)">
            </div>
            
            <div class="input-group">
                <input type="password" id="sifreInput" placeholder="≈ûifre">
            </div>
            
            <button onclick="islemYap()" id="btnIslem" class="auth-btn">Giri≈ü Yap</button>

            <span onclick="sifreSifirla()" class="link-text">≈ûifremi Unuttum?</span>
            <span onclick="modDegistir()" id="toggleText" class="link-text" style="color:#666; margin-top:25px;">Hesabƒ±n yok mu? <b style="color:var(--primary)">Kayƒ±t Ol</b></span>
        </div>
    </div>

    <div id="appScreen" class="container gizli">
        <div class="sidebar">
            <h3 style="text-align:center; color: var(--primary); margin-bottom: 20px;"><i class="fas fa-graduation-cap"></i> Portal</h3>
            <div class="menu-item active" onclick="sayfaGec('dashboard')"><i class="fas fa-home"></i> Ana Sayfa</div>
            <div class="menu-item" onclick="sayfaGec('pomodoro')"><i class="fas fa-clock"></i> Ders & Mola</div>
            <div class="menu-item" onclick="sayfaGec('oyunlar')"><i class="fas fa-chess-king"></i>  Arena</div>
            <div class="menu-item" onclick="sayfaGec('todo')"><i class="fas fa-stopwatch"></i> Zamanlƒ± G√∂rev</div>
            <div class="menu-item" onclick="sayfaGec('notlar')"><i class="fas fa-calculator"></i> Not Hesapla</div>
            <div class="menu-item" onclick="sayfaGec('program')"><i class="fas fa-calendar-alt"></i> Ders Programƒ±</div>
            <div class="menu-item" onclick="sayfaGec('gunluk')"><i class="fas fa-book"></i> Gizli G√ºnl√ºk</div>
            <div class="menu-item" onclick="sayfaGec('sohbet')"><i class="fas fa-comments"></i> Genel Sohbet</div>
            <div class="menu-item" onclick="sayfaGec('iletisim')"><i class="fas fa-envelope"></i> √ñneri Kutusu</div>
            <div style="margin-top:auto; text-align:center;">
                <p id="karsilama" style="font-size:13px; font-weight:600; color:#555;"></p>
                <button onclick="cikisYap()" class="btn btn-kirmizi" style="width:100%; font-size:12px;">√áƒ±kƒ±≈ü Yap</button>
            </div>
        </div>

        <div class="content">
            
            <div id="dashboard" class="page active">
                <h1 style="color:var(--primary);">üëã Ho≈ügeldin, <span id="dashUser"></span></h1>
                <p>Bug√ºnk√º √ßalƒ±≈ümalarƒ±na kaldƒ±ƒüƒ±n yerden devam et.</p>
                <div style="display:flex; gap:20px; margin-top:30px; flex-wrap: wrap;">
                    <div style="flex:1; background:linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%); color:white; padding:25px; border-radius:15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                        <i class="fas fa-chess-knight" style="font-size:30px; opacity:0.8;"></i>
                        <h3>Satran√ß Puanƒ±</h3><h1 id="dashPuan" style="font-size:40px; margin:0;">0</h1>
                    </div>
                    <div style="flex:1; background:linear-gradient(135deg, #84fab0 0%, #8fd3f4 100%); color:white; padding:25px; border-radius:15px; box-shadow: 0 10px 20px rgba(0,0,0,0.1);">
                        <i class="fas fa-tasks" style="font-size:30px; opacity:0.8;"></i>
                        <h3>Bekleyen G√∂rev</h3><h1 id="dashGorev" style="font-size:40px; margin:0;">0</h1>
                    </div>
                </div>
            </div>

            <div id="pomodoro" class="page" style="text-align:center;">
                <h2 style="color:var(--text)">üçÖ Odaklanma Modu</h2>
                <div class="pomodoro-circle" id="pomoSure">25:00</div>
                <p id="pomoDurumYazisi" style="font-size:16px; color:#888; font-weight:600; min-height: 24px;"></p>
                <div style="margin-top:30px; display:flex; justify-content:center; gap:10px;">
                    <button class="btn btn-yesil" onclick="dersBaslat()"><i class="fas fa-play"></i> Ders Ba≈ülat</button>
                    <button class="btn btn-yesil" style="background:#0984e3;" onclick="molaBaslat()"><i class="fas fa-coffee"></i> Mola Ver</button>
                    <button id="pomoDurBtn" class="btn btn-kirmizi" onclick="pomoDuraklat()"><i class="fas fa-pause"></i> Durdur</button>
                </div>
            </div>

            <div id="oyunlar" class="page" style="position: relative;">
                <div id="beklemeEkrani" class="gizli">
                    <div id="beklemeIcerik">
                        <div class="spinner"></div><h2>RAKƒ∞P ARANIYOR...</h2>
                        <p>L√ºtfen bekleyin, uygun bir rakip bulunduƒüunda oyun ba≈ülayacak.</p>
                        <button onclick="beklemeyiIptalEt()" class="btn btn-kirmizi">Aramayƒ± ƒ∞ptal Et</button>
                    </div>
                    <div id="geriSayimIcerik" class="gizli" style="text-align:center;">
                        <h2>RAKƒ∞P BULUNDU!</h2>
                        <p>Ma√ß ba≈ülƒ±yor...</p>
                        <h1 id="geriSayimText" style="font-size:100px; color:var(--primary); margin:0;">5</h1>
                    </div>
                </div>
                
                <h2 style="text-align:center; margin-bottom:20px;">‚ôüÔ∏è Satran√ß Arenasƒ±</h2>
                <div id="lobiButonlari" style="text-align:center; padding: 40px; background:white; border-radius:15px; box-shadow:0 10px 30px rgba(0,0,0,0.05);">
                    <p style="margin-bottom:20px; font-size:18px;">Nasƒ±l oynamak istersin?</p>
                    <button class="btn btn-gri" style="padding:15px 30px; font-size:16px;" onclick="oyunModuSec('bot')"><i class="fas fa-robot"></i> Bot ile Alƒ±≈ütƒ±rma</button>
                    <button class="btn btn-yesil" style="padding:15px 30px; font-size:16px; background: linear-gradient(to right, #f2994a, #f2c94c);" onclick="dereceliGir()"><i class="fas fa-trophy"></i> Dereceli Ma√ß (Online)</button>
                </div>

                <div id="oyunAlani" class="gizli" style="text-align:center;">
                    <div class="chess-wrapper">
                        <div class="timers">
                            <div id="timerW" class="timer-box">‚ö™ 10:00</div>
                            <div id="timerB" class="timer-box">‚ö´ 10:00</div>
                        </div>
                        <div id="myBoard"></div>
                        <div style="margin-top:20px;">
                            <button class="btn btn-kirmizi" onclick="pesEt()"><i class="fas fa-flag"></i> Oyunu Bitir / Pes Et</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="todo" class="page">
                <h2>‚è±Ô∏è Zamanlƒ± G√∂revler</h2>
                <div style="display:flex; gap:10px;">
                    <input id="todoIn" placeholder="G√∂rev nedir? (√ñrn: 50 soru √ß√∂z)">
                    <input type="number" id="todoTime" placeholder="Sn" style="width:100px;">
                    <button class="btn btn-yesil" style="width:120px;" onclick="gorevEkle()">Ba≈ülat</button>
                </div>
                <div id="todoList" style="margin-top:20px;"></div>
            </div>

            <div id="notlar" class="page">
                <h2>üßÆ Vize / Final Hesapla</h2>
                <div style="display:flex; gap:10px;">
                    <input id="dersAdi" placeholder="Ders Adƒ±">
                    <input id="vizeNot" type="number" placeholder="Vize (%40)">
                    <input id="finalNot" type="number" placeholder="Final (%60)">
                    <button class="btn btn-yesil" onclick="notHesapla()">Hesapla</button>
                </div>
                <div id="notListesi" style="margin-top:20px;"></div>
            </div>

            <div id="program" class="page">
                <h2>üìÖ Haftalƒ±k Program</h2>
                <table id="programTablosu"><thead><tr><th>Saat</th><th>Pzt</th><th>Sal</th><th>√áar</th><th>Per</th><th>Cum</th></tr></thead><tbody></tbody></table>
                <button class="btn btn-yesil" style="margin-top:15px;" onclick="programKaydet()">Tabloyu Kaydet</button>
            </div>

            <div id="gunluk" class="page">
                <h2>üìî Gizli G√ºnl√ºk</h2>
                <p style="font-size:12px; color:#888;">Yazdƒ±klarƒ±n sadece "Oku" butonuna basƒ±nca g√∂r√ºn√ºr.</p>
                <textarea id="gunlukIn" rows="5" placeholder="Bug√ºn neler ya≈üadƒ±n?"></textarea>
                <button class="btn btn-yesil" onclick="gunlukEkle()">G√ºnl√ºƒüe Kilitle</button>
                <div id="gunlukList" style="margin-top:20px;"></div>
            </div>

            <div id="sohbet" class="page">
                <h2>üí¨ Genel Sohbet</h2>
                <div id="chatArea" style="height:400px; overflow-y:scroll; border:1px solid #eee; padding:15px; border-radius:15px; background:#fdfdfd; margin-bottom:15px;"></div>
                <div style="display:flex; gap:10px;">
                    <input id="chatIn" placeholder="Bir mesaj yaz...">
                    <button class="btn btn-yesil" style="width:100px;" onclick="chatYolla()"><i class="fas fa-paper-plane"></i></button>
                </div>
            </div>

            <div id="iletisim" class="page">
                <h2>üì¨ ≈ûikayet ve √ñneri</h2>
                <select id="oneriTur"><option value="√ñneri">√ñneri</option><option value="≈ûikayet">≈ûikayet</option></select>
                <input id="oneriKonu" placeholder="Konu Ba≈ülƒ±ƒüƒ±">
                <textarea id="oneriMesaj" rows="5" placeholder="Mesajƒ±nƒ±z..."></textarea>
                <button class="btn btn-yesil" onclick="oneriYolla()" style="background:#e17055; width:100%;">üìß E-Posta Hazƒ±rla ve G√∂nder</button>
            </div>

        </div>
    </div>

    <script>
        // --- API KODLARIN BURADA ---
        const firebaseConfig = {
          apiKey: "AIzaSyDxsw-OTjvlrPvscjO4LsGzKEceKOW-Iuc",
          authDomain: "ogrenci-portali-f4cad.firebaseapp.com",
          databaseURL: "https://ogrenci-portali-f4cad-default-rtdb.firebaseio.com",
          projectId: "ogrenci-portali-f4cad",
          storageBucket: "ogrenci-portali-f4cad.firebasestorage.app",
          messagingSenderId: "901945087688",
          appId: "1:901945087688:web:24f1a877f49a15edc577fd",
          measurementId: "G-JEL3H6H45T"
        };

        try { firebase.initializeApp(firebaseConfig); } catch(e){ console.error(e); }
        const database = firebase.database();
        const auth = firebase.auth();

        let user = null, kayit = false;
        let board = null, game = new Chess();
        let myColor = 'w', aktifMod = null;
        let wTime = 600, bTime = 600, chessInterval = null;

        if(localStorage.getItem("koyuMod") === "1") document.body.classList.add("koyu-mod");

        // --- Gƒ∞Rƒ∞≈û ---
        function modDegistir() { 
            kayit = !kayit; 
            document.getElementById("authTitle").innerText = kayit ? "Kayƒ±t Ol" : "Giri≈ü Yap";
            document.getElementById("btnIslem").innerText = kayit ? "Kayƒ±t Ol" : "Giri≈ü Yap";
            document.getElementById("toggleText").innerHTML = kayit ? "Zaten hesabƒ±n var mƒ±? <b style='color:var(--primary)'>Giri≈ü Yap</b>" : "Hesabƒ±n yok mu? <b style='color:var(--primary)'>Kayƒ±t Ol</b>";
            if(kayit) document.getElementById("emailDiv").classList.remove("gizli");
            else document.getElementById("emailDiv").classList.add("gizli");
        }

        function islemYap() {
            let kAdi = document.getElementById("kAdiInput").value.trim();
            let pass = document.getElementById("sifreInput").value;
            if(!kAdi || !pass) return alert("L√ºtfen alanlarƒ± doldurun!");

            if(kayit) {
                let email = document.getElementById("emailInput").value.trim();
                if(!email) return alert("E-Posta gerekli!");
                database.ref('users').orderByChild('username').equalTo(kAdi).once('value', s => {
                    if(s.exists()) return alert("Bu kullanƒ±cƒ± adƒ± alƒ±nmƒ±≈ü!");
                    auth.createUserWithEmailAndPassword(email, pass).then(cred => {
                        database.ref('users/' + cred.user.uid).set({ username: kAdi, email: email });
                        alert("Kayƒ±t Ba≈üarƒ±lƒ±! Giri≈ü yapƒ±lƒ±yor...");
                    }).catch(e => alert("Hata: " + e.message));
                });
            } else {
                database.ref('users').orderByChild('username').equalTo(kAdi).once('value', s => {
                    if(s.exists()) {
                        let data = Object.values(s.val())[0];
                        auth.signInWithEmailAndPassword(data.email, pass).catch(e => alert("≈ûifre yanlƒ±≈ü!"));
                    } else {
                        alert("Kullanƒ±cƒ± adƒ± bulunamadƒ±!");
                    }
                });
            }
        }

        auth.onAuthStateChanged(u => {
            if (u) {
                database.ref('users/' + u.uid).once('value').then(s => {
                    user = s.exists() ? s.val().username : u.email.split('@')[0];
                    document.getElementById("authScreen").classList.add("gizli");
                    document.getElementById("appScreen").classList.remove("gizli");
                    document.getElementById("karsilama").innerText = "üë§ " + user;
                    document.getElementById("dashUser").innerText = user;
                    yukleVeriler();
                    baslatSohbet();
                });
            } else {
                document.getElementById("authScreen").classList.remove("gizli");
                document.getElementById("appScreen").classList.add("gizli");
            }
        });

        function cikisYap() { auth.signOut().then(()=>location.reload()); }
        function sifreSifirla() {
            let m = prompt("E-Posta adresinizi girin:");
            if(m) auth.sendPasswordResetEmail(m).then(()=>alert("Mail g√∂nderildi!")).catch(e=>alert(e.message));
        }
        function getRef(path) { return database.ref(path + '/' + user); } 

        // --- POMODORO (HATA √ñNLEYƒ∞Cƒ∞) ---
        let pInt, pSur=25*60, pDur=false, pMod=""; 
        function dersBaslat() {
            if(pMod === 'mola' && pSur > 0 && pDur) return alert("Moladasƒ±n! √ñnce bitir.");
            if(pMod !== 'ders') { clearInterval(pInt); pSur = 25 * 60; pMod = 'ders'; }
            pDur = true; document.getElementById("pomoDurBtn").innerText = "Durdur"; 
            document.getElementById("pomoDurumYazisi").innerText = "üìö DERS √áALI≈ûILIYOR";
            sayac();
        }
        function molaBaslat() {
            if(pMod === 'ders' && pSur > 0 && pDur) return alert("Derstesin! √ñnce bitir.");
            if(pMod !== 'mola') { clearInterval(pInt); pSur = 5 * 60; pMod = 'mola'; }
            pDur = true; document.getElementById("pomoDurBtn").innerText = "Durdur";
            document.getElementById("pomoDurumYazisi").innerText = "‚òï MOLA ZAMANI";
            sayac();
        }
        function sayac() {
            clearInterval(pInt);
            pInt = setInterval(() => {
                pSur--;
                let m=Math.floor(pSur/60), s=pSur%60;
                document.getElementById("pomoSure").innerText = `${m}:${s<10?'0':''}${s}`;
                if(pSur<=0) { clearInterval(pInt); alert("S√ºre bitti!"); pDur = false; }
            }, 1000);
        }
        function pomoDuraklat() {
            if(pDur) { clearInterval(pInt); pDur=false; document.getElementById("pomoDurBtn").innerText = "Devam Et"; }
            else { pDur=true; document.getElementById("pomoDurBtn").innerText = "Durdur"; sayac(); }
        }

        // --- SATRAN√á ---
        function dereceliGir() {
            document.getElementById("lobiButonlari").classList.add("gizli");
            document.getElementById("beklemeEkrani").classList.remove("gizli");
            database.ref('lobby').once('value', s => {
                let lob = s.val();
                if(!lob || lob.status === 'empty') {
                    database.ref('lobby').set({status: 'waiting', p1: user});
                    myColor = 'w';
                    database.ref('lobby').on('child_changed', snap => { if(snap.val() === 'ready') baslatGeriSayim(); });
                } else if (lob.status === 'waiting') {
                    database.ref('lobby').update({status: 'ready', p2: user});
                    myColor = 'b';
                    baslatGeriSayim();
                } else { alert("Dolu"); beklemeyiIptalEt(); }
            });
        }
        function baslatGeriSayim() {
            document.getElementById("beklemeIcerik").classList.add("gizli");
            document.getElementById("geriSayimIcerik").classList.remove("gizli");
            let c = 5;
            let i = setInterval(() => {
                c--; document.getElementById("geriSayimText").innerText = c;
                if(c<=0) { clearInterval(i); oyunBaslat('online'); }
            }, 1000);
        }
        function oyunModuSec(t) { if(t==='bot') oyunBaslat('bot'); }
        function beklemeyiIptalEt() { database.ref('lobby').set({status:'empty'}); document.getElementById("beklemeEkrani").classList.add("gizli"); document.getElementById("lobiButonlari").classList.remove("gizli"); }
        function oyunBaslat(mod) {
            aktifMod = mod;
            document.getElementById("beklemeEkrani").classList.add("gizli");
            document.getElementById("oyunAlani").classList.remove("gizli");
            document.getElementById("lobiButonlari").classList.add("gizli");
            game.reset(); wTime = 600; bTime = 600; baslatSatrancSayaci();
            
            if(mod === 'online') {
                database.ref('game').on('value', s => {
                    let v = s.val(); if(v && v.fen !== game.fen()) { game.load(v.fen); board.position(v.fen); kontrolEtBittiMi(); }
                });
            }
            if(board) board.destroy();
            board = Chessboard('myBoard', {
                draggable: true, position: 'start',
                orientation: myColor === 'b' && mod === 'online' ? 'black' : 'white',
                onDragStart: (s, p) => {
                    if(game.game_over()) return false;
                    if(mod === 'online' && game.turn() !== myColor) return false;
                    if(mod === 'bot' && game.turn() === 'b') return false;
                },
                onDrop: (s, t) => {
                    let m = game.move({from: s, to: t, promotion: 'q'});
                    if(m === null) return 'snapback';
                    if(mod === 'online') database.ref('game').set({fen: game.fen(), turn: game.turn()});
                    if(mod === 'bot') setTimeout(() => {
                        let moves = game.moves(); game.move(moves[Math.floor(Math.random() * moves.length)]);
                        board.position(game.fen()); kontrolEtBittiMi();
                    }, 250);
                    kontrolEtBittiMi();
                }
            });
        }
        function baslatSatrancSayaci() {
            clearInterval(chessInterval);
            chessInterval = setInterval(() => {
                if(game.game_over()) { clearInterval(chessInterval); return; }
                if(game.turn() === 'w') { 
                    wTime--; document.getElementById("timerW").innerHTML = `‚ö™ ${Math.floor(wTime/60)}:${wTime%60<10?'0':''}${wTime%60}`; 
                    document.getElementById("timerB").classList.remove("timer-active"); document.getElementById("timerW").classList.add("timer-active"); 
                } else { 
                    bTime--; document.getElementById("timerB").innerHTML = `‚ö´ ${Math.floor(bTime/60)}:${bTime%60<10?'0':''}${bTime%60}`; 
                    document.getElementById("timerB").classList.add("timer-active"); document.getElementById("timerW").classList.remove("timer-active"); 
                }
                if(wTime<=0 || bTime<=0) { clearInterval(chessInterval); alert("S√ºre bitti!"); }
            }, 1000);
        }
        function kontrolEtBittiMi() { if(game.game_over()) { clearInterval(chessInterval); alert("Oyun Bitti!"); if(aktifMod === 'online') database.ref('lobby').set({status:'empty'}); } }
        function pesEt() { alert("Pes ettin!"); if(aktifMod === 'online') database.ref('lobby').set({status:'empty'}); location.reload(); }

        // --- Dƒ∞ƒûER FONKSƒ∞YONLAR ---
        function oneriYolla() {
            let t = document.getElementById("oneriTur").value, k = document.getElementById("oneriKonu").value, m = document.getElementById("oneriMesaj").value;
            if(!k || !m) return alert("Doldurun!");
            window.location.href = `mailto:mustafasoylemez2000@gmail.com?subject=[${t}] ${k} - ${user}&body=${m}`;
        }
        function gunlukEkle() { let t = document.getElementById("gunlukIn").value; if(t) { getRef('gunluk').push({txt:t, date: new Date().toLocaleDateString()}); document.getElementById("gunlukIn").value=""; } }
        function yukleVeriler() {
            getRef('gunluk').on('child_added', s => {
                let d = s.val(); let html = `<div class="item-card" style="display:block;"><div style="display:flex; justify-content:space-between;"><b>üìÖ ${d.date}</b><button class="btn btn-yesil" style="padding:2px 10px; font-size:12px;" onclick="toggleOku('${s.key}')">Oku</button></div><div id="g_${s.key}" class="gizli" style="margin-top:10px; border-top:1px solid #ccc; padding-top:5px;">${d.txt}</div></div>`;
                document.getElementById("gunlukList").insertAdjacentHTML('afterbegin', html);
            });
            getRef('todo').on('child_added', s => {
                let d = s.val();
                if(!document.getElementById("gorev_"+s.key)){
                    let icon = d.durum==='basarili' ? '‚úÖ' : (d.durum==='basarisiz' ? '‚ùå' : '‚è≥');
                    let stil = d.durum==='basarili' ? 'basarili' : (d.durum==='basarisiz' ? 'basarisiz' : '');
                    document.getElementById("todoList").innerHTML += `<div id="gorev_${s.key}" class="item-card ${stil}"><span>${d.txt} (${d.sure}sn)</span> ${icon}</div>`;
                }
            });
            programTabloOlustur();
        }
        window.toggleOku = function(id) { document.getElementById("g_"+id).classList.toggle("gizli"); }
        function gorevEkle() {
            let t = document.getElementById("todoIn").value, s = parseInt(document.getElementById("todoTime").value);
            if(!t || !s) return;
            let ref = getRef('todo').push(); ref.set({txt:t, sure:s, durum:'bekliyor'});
            document.getElementById("todoIn").value="";
            baslatGorevSayaci(ref.key, t, s);
        }
        function baslatGorevSayaci(key, txt, sure) {
            let div = document.createElement("div"); div.id = "temp_" + key; div.className = "item-card"; div.style.borderLeftColor = "#f1c40f";
            div.innerHTML = `<span>${txt}</span> <b id="cnt_${key}">${sure}</b> <button class="btn btn-yesil" onclick="gorevSonuc('${key}', 'basarili')">Bitir</button>`;
            document.getElementById("todoList").prepend(div);
            let int = setInterval(() => {
                sure--; let el = document.getElementById("cnt_"+key); if(el) el.innerText = sure;
                if(sure <= 0) { clearInterval(int); gorevSonuc(key, 'basarisiz'); }
                if(!document.getElementById("temp_"+key)) clearInterval(int);
            }, 1000);
        }
        window.gorevSonuc = function(key, durum) {
            let div = document.getElementById("temp_"+key); if(div) div.remove();
            getRef('todo/'+key).update({durum: durum});
        }
        function notHesapla() { let d=document.getElementById("dersAdi").value, v=Number(document.getElementById("vizeNot").value), f=Number(document.getElementById("finalNot").value); if(d) getRef('notlar').push({ders:d, sonuc:((v*0.4)+(f*0.6)).toFixed(1)}); }
        function programTabloOlustur(){
            let t=document.querySelector("#programTablosu tbody"); t.innerHTML="";
            getRef('program').once('value', sn=>{
                let d=sn.val()||{};
                ["09:00","10:00","11:00","13:00","14:00"].forEach((saat,i)=>{
                    let tr=document.createElement("tr"); tr.innerHTML=`<td><b>${saat}</b></td>`;
                    for(let j=0;j<5;j++) tr.innerHTML+=`<td><input class="ders-input" id="d_${i}_${j}" value="${d['d_'+i+'_'+j]||''}"></td>`;
                    t.appendChild(tr);
                });
            });
        }
        function programKaydet(){ let v={}; document.querySelectorAll(".ders-input").forEach(i=>v[i.id]=i.value); getRef('program').set(v).then(()=>alert("Kaydedildi")); }
        function baslatSohbet(){ database.ref('chat').on('child_added',s=>{ let m=s.val(); let st=m.u===user?"background:#6c5ce7;color:white;margin-left:auto;":"background:#eee;color:black;"; document.getElementById("chatArea").innerHTML+=`<div style="padding:8px;margin:5px;border-radius:10px;width:fit-content;${st}"><b>${m.u}:</b> ${m.t}</div>`; }); }
        function chatYolla(){ let t=document.getElementById("chatIn").value; if(t){ database.ref('chat').push({u:user, t:t}); document.getElementById("chatIn").value=""; } }
        function sayfaGec(id){ document.querySelectorAll(".page").forEach(p=>p.classList.remove("active")); document.querySelectorAll(".menu-item").forEach(m=>m.classList.remove("active")); document.getElementById(id).classList.add("active"); event.currentTarget.classList.add("active"); }
    </script>
</body>
</html>
